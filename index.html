<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Howardçš„ä¸»æ‰“æ­Œæ¸…å–®</title>
  <style>
    /* Live2D æ—‹è½‰èˆ‡ä½ç½®è¨­å®š */
    #waifu {
      bottom: auto !important;
      right: auto !important;
      top: 0 !important;
      transform: rotate(180deg) !important;
      transform-origin: center center !important;
    }
    #waifu-tips {
      left: auto !important;
      right: 100% !important;
      margin-right: 10px;
    }

    /* å…¨åŸŸæ¨£å¼ */
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 20px;
      padding-bottom: 160px; /* ç‚ºåº•éƒ¨æ’­æ”¾å™¨ç•™å‡ºç©ºé–“ */
    }

    h1.page-title {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 28px;
    }

    /* ä¸»å®¹å™¨ï¼šå·¦é‚Šæ­Œå–®ï¼Œå³é‚Šæ­Œè© */
    .main-layout {
      display: flex;
      max-width: 1300px;
      margin: 0 auto;
      gap: 30px;
      align-items: flex-start;
    }

    /* æ­Œå–®ç¶²æ ¼ï¼šä¸€æ’ä¸‰é¡†å¡ç‰‡ */
    .song-grid {
      flex: 2; /* ä½”æ“šè¼ƒå¤§æ¯”ä¾‹ */
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    /* æ­Œæ›²å¡ç‰‡æ¨£å¼ */
    .song-card {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      cursor: pointer;
      border: 2px solid transparent;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 160px;
      text-align: center;
    }

    .song-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }

    .song-card.active-card {
      border-color: #007bff;
      background-color: #f0f7ff;
    }

    .song-card h2 {
      color: #007bff;
      font-size: 1.1rem;
      margin: 0 0 10px 0;
      line-height: 1.4;
    }

    .play-hint {
      font-size: 12px;
      color: #999;
      margin-bottom: 15px;
    }

    .lyrics-btn {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 15px;
      font-size: 13px;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
    }

    .lyrics-btn:hover {
      background-color: #0056b3;
    }

    /* å³å´æ­Œè©å›ºå®šé¢æ¿ */
    .lyrics-side-panel {
      flex: 1; 
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      position: sticky;
      top: 20px;
      max-height: 75vh;
      overflow-y: auto;
      display: none; 
    }

    .lyrics-side-panel h3 {
      color: #007bff;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      margin-top: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .close-lyrics-btn {
      background: #f1f3f5;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 18px;
      cursor: pointer;
      color: #666;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .close-lyrics-btn:hover {
      background: #007bff;
      color: white;
    }

    .lyrics-content {
      white-space: pre-line;
      line-height: 1.8;
      color: #444;
      font-size: 15px;
    }

    /* åº•éƒ¨å›ºå®šæ’­æ”¾å™¨ */
    #player-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: white;
      box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
      padding: 15px 0;
      display: none; /* æ’­æ”¾æ™‚ç”± JS é¡¯ç¤º */
      z-index: 1000;
      flex-direction: column;
      align-items: center;
    }

    .player-inner {
      width: 90%;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .current-info {
      font-weight: bold;
      color: #007bff;
      margin-bottom: 10px;
    }

    .player-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
    }

    .ctrl-btn {
      background: #f1f3f5;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 5px 15px;
      font-size: 13px;
      cursor: pointer;
    }

    .ctrl-btn.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }

    audio {
      width: 100%;
      height: 40px;
    }

    @media (max-width: 900px) {
      .main-layout { flex-direction: column; }
      .song-grid { grid-template-columns: 1fr; width: 100%; }
      .lyrics-side-panel { position: static; width: 100%; box-sizing: border-box; }
    }
  </style>
</head>
<body>

  <h1 class="page-title">Howard çš„å°ˆå±¬ä¸»æ‰“æ­Œæ¸…å–®</h1>

  <div class="main-layout">
    <!-- å·¦å´æ­Œå–®ç¶²æ ¼ -->
    <div class="song-grid" id="playlist"></div>

    <!-- å³å´æ­Œè©é¡¯ç¤ºå€ -->
    <div class="lyrics-side-panel" id="lyrics-panel">
      <h3>
        <span id="panel-title">æ­Œæ›²æ¨™é¡Œ</span>
        <button class="close-lyrics-btn" onclick="closeLyrics()" title="é—œé–‰æ­Œè©">Ã—</button>
      </h3>
      <div class="lyrics-content" id="panel-body"></div>
    </div>
  </div>

  <!-- åº•éƒ¨æ’­æ”¾å™¨ -->
  <div id="player-bar">
    <div class="player-inner">
      <div class="current-info" id="now-playing-text">æº–å‚™æ’­æ”¾...</div>
      <div class="player-controls">
        <button class="ctrl-btn" id="btn-shuffle" onclick="toggleShuffle()">ğŸ”€ éš¨æ©Ÿæ’­æ”¾ï¼šé—œ</button>
        <button class="ctrl-btn" id="btn-loop" onclick="toggleLoop()">ğŸ”‚ å–®æ›²å¾ªç’°ï¼šé—œ</button>
      </div>
      <audio id="main-audio" controls>
        <source src="" type="audio/mpeg">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´éŸ³æ¨‚æ’­æ”¾ã€‚
      </audio>
    </div>
  </div>

  <script src="https://fastly.jsdelivr.net/npm/live2d-widgets@1.0.0/dist/autoload.js"></script>

  <script>
    const songs = [
      {
        title: "Howard Leeæœ‰å¾ˆå¤šå¥³æœ‹å‹",
        src: "songs/song1.mp3",
        lyricsFile: "lyrics/song1.txt"
      },
      {
        title: "è¢å¹•çš„è—å…‰ï¼Œæ˜ åœ¨Howardè’¼ç™½çš„è‡‰",
        src: "songs/song2.mp3",
        lyricsFile: "lyrics/song2.txt"
      },
      {
        title: "Runtime Error",
        src: "songs/song3.mp3",
        lyricsFile: "lyrics/song3.txt"
      },
      {
        title: "Howardçš„å®‡å®™",
        src: "songs/song4.mp3",
        lyricsFile: "lyrics/song4.txt"
      },
      {
        title: "Howardæ‡‰æ´æ›²",
        src: "songs/song5.mp3",
        lyricsFile: "lyrics/song5.txt"
      },
      {
        title: "æ„›æƒ…é¡§å•Howard",
        src: "songs/song6.mp3",
        lyricsFile: "lyrics/song6.txt"
      },
      {
        title: "Howardæ˜¯å¸¥æ½®ï¼Œå› ç‚ºä»–æ½®å¸¥",
        src: "songs/song7.mp3",
        lyricsFile: "lyrics/song7.txt"
      }
    ];

    // è¼‰å…¥æ­Œè©çš„å¿«å–
    const lyricsCache = {};

    // éåŒæ­¥è¼‰å…¥æ­Œè©
    async function loadLyrics(lyricsFile) {
      if (lyricsCache[lyricsFile]) {
        return lyricsCache[lyricsFile];
      }
      try {
        const response = await fetch(lyricsFile);
        const text = await response.text();
        lyricsCache[lyricsFile] = text;
        return text;
      } catch (error) {
        console.error('è¼‰å…¥æ­Œè©å¤±æ•—:', error);
        return 'æ­Œè©è¼‰å…¥å¤±æ•—';
      }
    }

    let currentSongIndex = -1;
    let isShuffle = false;
    let isLoop = false;
    const audioPlayer = document.getElementById('main-audio');
    const playerBar = document.getElementById('player-bar');
    const nowPlayingText = document.getElementById('now-playing-text');
    const playlistContainer = document.getElementById('playlist');
    const lyricsPanel = document.getElementById('lyrics-panel');
    const panelTitle = document.getElementById('panel-title');
    const panelBody = document.getElementById('panel-body');

    // æ¸²æŸ“æ­Œå–®
    function renderPlaylist() {
      playlistContainer.innerHTML = '';
      songs.forEach((song, index) => {
        const card = document.createElement('div');
        card.className = 'song-card';
        card.id = `card-${index}`;
        card.onclick = (e) => {
          if (e.target.tagName === 'BUTTON') return;
          playSong(index);
        };

        card.innerHTML = `
          <div>
            <h2>${song.title}</h2>
            <div class="play-hint" id="hint-${index}">â–¶ é»æ“Šæ’­æ”¾</div>
          </div>
          <button class="lyrics-btn" onclick="showLyrics(${index})">ğŸ“ æŸ¥çœ‹æ­Œè©</button>
        `;
        playlistContainer.appendChild(card);
      });
    }

    // æ’­æ”¾æ­Œæ›²
    function playSong(index) {
      currentSongIndex = index;
      playerBar.style.display = 'flex';
      audioPlayer.src = songs[index].src;
      nowPlayingText.innerText = `æ­£åœ¨æ’­æ”¾ï¼š${songs[index].title}`;
      audioPlayer.play();
      updateActiveUI();
    }

    // æ›´æ–°æ­£åœ¨æ’­æ”¾çš„ UI ç‹€æ…‹
    function updateActiveUI() {
      document.querySelectorAll('.song-card').forEach(c => c.classList.remove('active-card'));
      document.querySelectorAll('.play-hint').forEach(h => h.innerText = "â–¶ é»æ“Šæ’­æ”¾");
      
      const activeCard = document.getElementById(`card-${currentSongIndex}`);
      if (activeCard) {
        activeCard.classList.add('active-card');
        document.getElementById(`hint-${currentSongIndex}`).innerText = "ğŸµ æ’­æ”¾ä¸­...";
      }
    }

    // æ­Œè©è‡ªå‹•æ»‘å‹•ï¼ˆå¹³å‡åˆ†é…ï¼‰
    let lyricsTimer = null;
    let lyricsActiveIndex = -1;
    let currentLyrics = [];

    async function showLyrics(index) {
      lyricsPanel.style.display = 'block';
      panelTitle.innerText = songs[index].title;
      panelBody.innerHTML = '<span style="color:#bbb">è¼‰å…¥ä¸­...</span>';

      const lyricsText = await loadLyrics(songs[index].lyricsFile);
      currentLyrics = lyricsText.split(/\r?\n/).filter(line => line.trim().length > 0);
      lyricsActiveIndex = -1;
      panelBody.innerHTML = currentLyrics.map((l, i) => `<div class=\"lyrics-line\" id=\"lyric-line-${i}\">${l}</div>`).join('');

      if (window.innerWidth <= 900) {
        lyricsPanel.scrollIntoView({ behavior: 'smooth' });
      }

      bindLyricsSync();
    }

    function closeLyrics() {
      lyricsPanel.style.display = 'none';
      unbindLyricsSync();
    }

    function bindLyricsSync() {
      unbindLyricsSync();
      lyricsTimer = setInterval(syncLyrics, 300);
    }
    function unbindLyricsSync() {
      if (lyricsTimer) clearInterval(lyricsTimer);
      lyricsTimer = null;
      lyricsActiveIndex = -1;
    }
    function syncLyrics() {
      if (!currentLyrics.length || !audioPlayer.duration) return;
      const currentTime = audioPlayer.currentTime;
      const total = currentLyrics.length;
      // å¹³å‡åˆ†é…æ¯è¡Œæ­Œè©çš„æ™‚é–“
      const secondsPerLine = audioPlayer.duration / total;
      let idx = Math.floor(currentTime / secondsPerLine);
      if (idx >= total) idx = total - 1;
      if (idx !== lyricsActiveIndex) {
        if (lyricsActiveIndex >= 0) {
          const oldLine = document.getElementById(`lyric-line-${lyricsActiveIndex}`);
          if (oldLine) oldLine.classList.remove('active');
        }
        if (idx >= 0) {
          const newLine = document.getElementById(`lyric-line-${idx}`);
          if (newLine) {
            newLine.classList.add('active');
            // è‡ªå‹•æ»¾å‹•åˆ°ä¸­é–“
            const panel = panelBody;
            const offset = newLine.offsetTop - panel.offsetHeight/2 + newLine.offsetHeight/2;
            panel.scrollTo({ top: offset, behavior: 'smooth' });
          }
        }
        lyricsActiveIndex = idx;
      }
    }

    function closeLyrics() {
      lyricsPanel.style.display = 'none';
    }

    function toggleShuffle() {
      isShuffle = !isShuffle;
      const btn = document.getElementById('btn-shuffle');
      btn.classList.toggle('active', isShuffle);
      btn.innerText = isShuffle ? "ğŸ”€ éš¨æ©Ÿæ’­æ”¾ï¼šé–‹" : "ğŸ”€ éš¨æ©Ÿæ’­æ”¾ï¼šé—œ";
    }

    function toggleLoop() {
      isLoop = !isLoop;
      audioPlayer.loop = isLoop;
      const btn = document.getElementById('btn-loop');
      btn.classList.toggle('active', isLoop);
      btn.innerText = isLoop ? "ğŸ”‚ å–®æ›²å¾ªç’°ï¼šé–‹" : "ğŸ”‚ å–®æ›²å¾ªç’°ï¼šé—œ";
    }

    // è‡ªå‹•æ’­æ”¾ä¸‹ä¸€é¦–
    audioPlayer.onended = function() {
      if (isLoop) return;
      let nextIndex;
      if (isShuffle) {
        do {
          nextIndex = Math.floor(Math.random() * songs.length);
        } while (nextIndex === currentSongIndex && songs.length > 1);
      } else {
        nextIndex = (currentSongIndex + 1) % songs.length;
      }
      playSong(nextIndex);
    };

    renderPlaylist();
  </script>
</body>
</html>
